#!/bin/bash
#
# preinstall
# AES67 macOS Driver Installer - Pre-installation script
# This script runs before the package is installed
#

set -e  # Exit on any error

# Logging
LOG_FILE="/tmp/aes67driver_install.log"
echo "=== AES67 Driver Pre-Installation Check ===" | tee "$LOG_FILE"
echo "Date: $(date)" | tee -a "$LOG_FILE"

# Check macOS version
echo "Checking macOS version..." | tee -a "$LOG_FILE"
OS_VERSION=$(sw_vers -productVersion)
OS_MAJOR=$(echo "$OS_VERSION" | cut -d. -f1)

echo "Detected macOS version: $OS_VERSION" | tee -a "$LOG_FILE"

if [ "$OS_MAJOR" -lt 13 ]; then
    echo "ERROR: This driver requires macOS 13.0 (Ventura) or later" | tee -a "$LOG_FILE"
    echo "Your system is running macOS $OS_VERSION" | tee -a "$LOG_FILE"
    exit 1
fi

echo "✓ macOS version check passed" | tee -a "$LOG_FILE"

# Check architecture
echo "Checking system architecture..." | tee -a "$LOG_FILE"
ARCH=$(uname -m)
echo "Detected architecture: $ARCH" | tee -a "$LOG_FILE"

if [ "$ARCH" != "arm64" ]; then
    echo "WARNING: This driver is optimized for Apple Silicon (arm64)" | tee -a "$LOG_FILE"
    echo "Your system architecture is: $ARCH" | tee -a "$LOG_FILE"
    echo "The driver may not work on Intel Macs" | tee -a "$LOG_FILE"
fi

# Check for sufficient disk space (at least 50MB)
echo "Checking available disk space..." | tee -a "$LOG_FILE"
AVAILABLE_KB=$(df -k /Library | tail -1 | awk '{print $4}')
REQUIRED_KB=51200  # 50MB in KB

if [ "$AVAILABLE_KB" -lt "$REQUIRED_KB" ]; then
    echo "ERROR: Insufficient disk space" | tee -a "$LOG_FILE"
    echo "Required: 50MB, Available: $((AVAILABLE_KB / 1024))MB" | tee -a "$LOG_FILE"
    exit 1
fi

echo "✓ Disk space check passed" | tee -a "$LOG_FILE"

# Check if we're running as root (installer should handle this)
if [ "$EUID" -ne 0 ]; then
    echo "WARNING: Installer must run with administrator privileges" | tee -a "$LOG_FILE"
fi

# Warn about existing installation
INSTALL_DIR="/Library/Audio/Plug-Ins/HAL"
DRIVER_PATH="${INSTALL_DIR}/AES67Driver.driver"

if [ -d "$DRIVER_PATH" ]; then
    echo "Found existing AES67 Driver installation" | tee -a "$LOG_FILE"
    echo "Previous version will be replaced" | tee -a "$LOG_FILE"
fi

# Display warnings
echo "" | tee -a "$LOG_FILE"
echo "=== IMPORTANT WARNINGS ===" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "This is EXPERIMENTAL software:" | tee -a "$LOG_FILE"
echo "  - NOT tested with real AES67 hardware" | tee -a "$LOG_FILE"
echo "  - May NOT work with production audio equipment" | tee -a "$LOG_FILE"
echo "  - Could cause system instability" | tee -a "$LOG_FILE"
echo "  - NOT recommended for production use" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Core Audio will be restarted after installation." | tee -a "$LOG_FILE"
echo "All audio applications will be briefly interrupted." | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"

echo "Pre-installation checks complete" | tee -a "$LOG_FILE"

exit 0
