#!/bin/bash
#
# postinstall
# AES67 macOS Driver Installer - Post-installation script
# This script runs after the package is installed
#

set -e  # Exit on any error

# Logging
LOG_FILE="/tmp/aes67driver_install.log"
echo "=== AES67 Driver Post-Installation Script ===" | tee -a "$LOG_FILE"
echo "Date: $(date)" | tee -a "$LOG_FILE"

# Paths
DRIVER_NAME="AES67Driver.driver"
INSTALL_DIR="/Library/Audio/Plug-Ins/HAL"
DRIVER_PATH="${INSTALL_DIR}/${DRIVER_NAME}"
SOURCE_DRIVER="$2/${DRIVER_NAME}"  # $2 is the package path

echo "Installing AES67 Audio Driver..." | tee -a "$LOG_FILE"

# Create HAL plug-ins directory if it doesn't exist
if [ ! -d "$INSTALL_DIR" ]; then
    echo "Creating HAL plug-ins directory: $INSTALL_DIR" | tee -a "$LOG_FILE"
    mkdir -p "$INSTALL_DIR"
fi

# Remove old version if it exists
if [ -d "$DRIVER_PATH" ]; then
    echo "Removing previous version..." | tee -a "$LOG_FILE"
    rm -rf "$DRIVER_PATH"
fi

# Copy driver bundle to system location
echo "Copying driver bundle to $INSTALL_DIR..." | tee -a "$LOG_FILE"
cp -R "$SOURCE_DRIVER" "$INSTALL_DIR/" || {
    echo "ERROR: Failed to copy driver bundle" | tee -a "$LOG_FILE"
    exit 1
}

# Set ownership to root:wheel
echo "Setting ownership to root:wheel..." | tee -a "$LOG_FILE"
chown -R root:wheel "$DRIVER_PATH"

# Set permissions: readable and executable by all, writable only by root
echo "Setting permissions..." | tee -a "$LOG_FILE"
chmod -R 755 "$DRIVER_PATH"

# Verify installation
if [ -d "$DRIVER_PATH" ]; then
    echo "✓ Driver installed successfully at: $DRIVER_PATH" | tee -a "$LOG_FILE"
else
    echo "ERROR: Driver installation failed - bundle not found" | tee -a "$LOG_FILE"
    exit 1
fi

# Restart Core Audio to load the new driver
echo "Restarting Core Audio service..." | tee -a "$LOG_FILE"
killall coreaudiod 2>/dev/null || true

# Wait for Core Audio to restart
sleep 2

# Verify Core Audio is running
if pgrep -x "coreaudiod" > /dev/null; then
    echo "✓ Core Audio restarted successfully" | tee -a "$LOG_FILE"
else
    echo "WARNING: Core Audio may not have restarted properly" | tee -a "$LOG_FILE"
fi

echo "" | tee -a "$LOG_FILE"
echo "=== Installation Complete ===" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "The AES67 Driver has been installed." | tee -a "$LOG_FILE"
echo "The driver should now appear as 'AES67 Device' in:" | tee -a "$LOG_FILE"
echo "  - System Settings → Sound" | tee -a "$LOG_FILE"
echo "  - Audio MIDI Setup" | tee -a "$LOG_FILE"
echo "  - Your DAW's audio device settings" | tee -a "$LOG_FILE"
echo "" | tee -a "$LOG_FILE"
echo "Installation log saved to: $LOG_FILE" | tee -a "$LOG_FILE"

exit 0
